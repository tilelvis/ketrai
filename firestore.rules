rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for RBAC
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    function getRole() { return get(/databases/$(database)/documents/users/$(uid())).data.role; }
    function isAdmin() { return getRole() == 'admin'; }
    function isManager() { return getRole() == 'manager'; }
    function isClaims() { return getRole() == 'claims'; }
    function isDispatcher() { return getRole() == 'dispatcher'; }
    function isSupport() { return getRole() == 'support'; }
    function isManagerOrAdmin() { return isManager() || isAdmin(); }

    // User profiles can be read by their owner or admins/managers.
    // Users can only update their own profile.
    match /users/{userId} {
      allow read: if isAuth() && (userId == uid() || isManagerOrAdmin());
      allow create: if isAuth(); // For new sign-ups
      allow update: if isAuth() && userId == uid(); // Users can update their own profile
      allow delete: if false;

      // Notifications are private to the user.
      match /notifications/{notifId} {
        allow read, update, delete: if isAuth() && userId == uid();
        // Creation is done by server-side logic (Cloud Functions), not directly by clients.
        // We leave this open for backend processes.
        allow create: if isAuth();
      }
    }

    // Claims:
    // - Any authenticated user can create.
    // - Requester, claims officers, managers, and admins can read.
    // - Only claims officers and admins can update the status.
    match /claims/{claimId} {
      allow create: if isAuth();
      allow read: if isAuth() && (resource.data.requesterId == uid() || isClaims() || isManagerOrAdmin());
      allow update: if isAuth() && (isClaims() || isAdmin());
      allow delete: if false;

      // Claim history is append-only.
      // Readable by the same roles who can read the parent claim.
      match /history/{eventId} {
        allow create: if isAuth(); // Created by backend logic
        allow read: if isAuth() && (get(/databases/$(database)/documents/claims/$(claimId)).data.requesterId == uid() || isClaims() || isManagerOrAdmin());
        allow update, delete: if false;
      }
    }

    // Dispatch jobs: 
    // - Can be created by dispatchers or admins.
    // - Can be read by assigned courier, manager, or admin.
    // - Can be updated by assigned courier (status), dispatcher, or admin.
    match /dispatch/{jobId} {
      allow create: if isAuth() && (isDispatcher() || isAdmin());
      allow read: if isAuth() && (resource.data.courierId == uid() || isManagerOrAdmin());
      allow update: if isAuth() && (resource.data.courierId == uid() || isDispatcher() || isAdmin());
      allow delete: if false;
    }

    // Audit logs are immutable and can only be read by managers/admins.
    match /auditLogs/{logId} {
      allow create: if isAuth(); // Any authenticated action can generate a log entry
      allow read: if isAuth() && isManagerOrAdmin();
      allow update, delete: if false;
    }
  }
}
